<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - AnviPayz</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <script>
        (function () {
            const savedTheme = localStorage.getItem('anvi-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>
    <div class="auth-wrapper">
        <div class="card auth-card">
            <h1 style="color: var(--primary); margin-bottom: 0.5rem;">AnviPayz</h1>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Create a strong new password for your account.</p>

            <form id="reset-form">
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="new-password" class="form-input" placeholder="••••••••" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="••••••••" required minlength="6">
                </div>

                <button type="submit" id="reset-btn" class="btn-primary">Update Password</button>
            </form>

            <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-muted);">
                Remembered your password? <a href="index.html" style="color: var(--primary); font-weight: 600;">Log In</a>
            </p>
        </div>
    </div>

    <script type="module">
        import { auth } from "./js/firebase-config.js";
        import { confirmPasswordReset, verifyPasswordResetCode } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const resetForm = document.getElementById('reset-form');
        const btn = document.getElementById('reset-btn');

        // URL se 'oobCode' nikaalna
        const urlParams = new URLSearchParams(window.location.search);
        const actionCode = urlParams.get('oobCode');

        if (!actionCode) {
            alert("Invalid or expired link. Please request a new password reset.");
            window.location.href = "index.html";
        }

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (newPass !== confirmPass) {
                alert("Passwords do not match!");
                return;
            }

            try {
                btn.innerText = "Updating...";
                btn.disabled = true;

                // 1. Pehle code verify karo (Optional but safe)
                await verifyPasswordResetCode(auth, actionCode);
                
                // 2. Password confirm/update karo
                await confirmPasswordReset(auth, actionCode, newPass);

                alert("Password updated successfully! You can now login.");
                window.location.href = "index.html";

            } catch (error) {
                console.error(error);
                btn.innerText = "Update Password";
                btn.disabled = false;
                
                if (error.code === "auth/expired-action-code") {
                    alert("The link has expired. Please request a new one.");
                } else if (error.code === "auth/invalid-action-code") {
                    alert("The link is invalid. Please try again.");
                } else {
                    alert("Error: " + error.message);
                }
            }
        });
    </script>
</body>
</html>